{% extends "base.html" %}

{% block content %}

<style>
    /* ì‘ì€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
    .thumbnail {
        width: 25px;
        cursor: pointer;
        margin: 0px;
    }

    /* íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
        display: none; /* ì²˜ìŒì—ëŠ” ìˆ¨ê²¨ì ¸ ìˆìŒ */
        position: fixed;
        z-index: 1; /* í™”ë©´ ìœ„ìª½ì— ìœ„ì¹˜ */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); /* ë°˜íˆ¬ëª… ë°°ê²½ */
        overflow: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
        padding-top: 50px;
    }

    /* íŒì—… ë‚´ìš© ìŠ¤íƒ€ì¼ */
    .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
    }

    /* ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>

<h2>ğŸ“‚ í”„ë¡œì íŠ¸ íŒŒì¼ ì—…ë¡œë“œ</h2>

<!-- âœ… ì—…ë¡œë“œ í´ë” í…Œì´ë¸” -->
<h3>âœ… í˜„ì¬ ì—…ë¡œë“œëœ í˜„ì¥ì´¬ì˜ ì´ë¯¸ì§€</h3>

{% if date_folders_imgs %}
<form id="delete-form">
    <table border="1">
        <thead>
            <tr>
                <th></th>
                <th></th>

                {% for date in date_folders_imgs %}
                <th>Delete<input type="checkbox" class="column-checkbox" value="{{ date }}"></th>
                {% endfor %}
            </tr>

            <tr>
                <th>ì¸µ</th>
                <th>ë„ë©´</th>
                {% for date in date_folders_imgs %}
                <th>{{ date }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for floor in floor_folders  %}
            <tr>
                <td>{{ floor }}</td>

                <!-- âœ… ì¸µë³„ ë„ë©´ ì´ë¯¸ì§€ -->
                <td>
                {% if floor in floor_imgs %}
                    {% for flr, url in floor_imgs.items %}
                        {% if floor == flr %}
                        <img src= {{url}}  class="thumbnail" onclick="openModal(this)">
                        {% endif %}
                    {% endfor %}
                {% endif %}
                </td>

                {% for date in date_folders_imgs %}
                <td>
                    {% for floor_status, date_status_dict in sfm_status.items %}
                        {% for date_status, excuteoredit in date_status_dict.items %}
                            {% if floor == floor_status and date == date_status %}
                                {% if excuteoredit == 'edit' %}                           
                                    <!-- âœ… SFM í¸ì§‘ ë²„íŠ¼ -->
                                    <form method="post" action="{% url 'panorama-editor' project.id %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="date" value="{{ date }}">
                                        <input type="hidden" name="floor" value="{{ floor }}">
                                        <button type="submit" class="edit-sfm-btn" value="{{ date }}-{{ floor }}">âœï¸ Edit </button>
                                    </form>
                                {% elif excuteoredit == 'excute' %}                           
                                    <!-- âœ… SFM ì‹¤í–‰ ë²„íŠ¼ (SFM í¸ì§‘ ë²„íŠ¼ì´ ì—†ì„ ê²½ìš°) -->
                                    <form method="post" action="{% url 'sfm-execute' project.id %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="date" value="{{ date }}">
                                        <input type="hidden" name="floor" value="{{ floor }}">
                                        <button type="submit" class="run-sfm-btn" value="{{ date }}-{{ floor }}">ğŸ¥ SfM </button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </td>
                {% endfor %}

            </tr>
            {% endfor %}

        </tbody>
    </table>

    <button type="button" id="delete-selected">ì„ íƒí•œ í´ë” ì‚­ì œ</button>
</form>
{% else %}
ì—…ë¡œë“œëœ í´ë” ì—†ìŒ
{% endif %}


<!-- íŒì—… ëª¨ë‹¬ -->
<div id="myModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
</div>


<h3>â¬†ï¸ í˜„ì¥ ì´¬ì˜ì´ë¯¸ì§€ ì—…ë¡œë“œ(ZIP)</h3>

<form method="post" enctype="multipart/form-data">
    <input type="hidden" name="form_type" value="main">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ</button>
</form>

<h3>â¬†ï¸ ì¸µë³„ í‰ë©´ë„ ì—…ë¡œë“œ(ZIP)</h3>
<form method="post" enctype="multipart/form-data">
    <input type="hidden" name="form_type" value="map">
    {% csrf_token %}
    {{ form1.as_p }}
    <button type="submit" class="btn btn-primary2">ì—…ë¡œë“œ</button>
</form>

<a href="{% url 'project-list' %}" class="btn btn-secondary">ëŒì•„ê°€ê¸°</a>


<script>
    document.getElementById("delete-selected").addEventListener("click", function() {
        let selectedFolders = [];
        document.querySelectorAll(".column-checkbox:checked").forEach(checkbox => {
            selectedFolders.push(checkbox.value);
        });

        if (selectedFolders.length === 0) {
            alert("ì‚­ì œí•  í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        fetch("{% url 'delete-selected-folders' project.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({ "folders[]": selectedFolders })
        })
        .then(response => response.json())
        .then(data => {
            if (data.deleted) {
                alert("ì‚­ì œ ì™„ë£Œ: " + data.deleted.join(", "));
                location.reload();
            }
        })
        .catch(error => console.error("Error:", error));
    });

    // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function openModal(element) {
        var modal = document.getElementById("myModal");
        var modalImage = document.getElementById("modalImage");
        
        // ëª¨ë‹¬ì— ì´ë¯¸ì§€ ì„¤ì •
        modal.style.display = "block";
        modalImage.src = element.src;
    }

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeModal() {
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
    }
</script>
    
{% endblock %}
